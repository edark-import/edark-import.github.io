<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="En eDark Alpha Technologies somos especialistas en productos tecnol√≥gicos, servicios de consultor√≠a y soporte t√©cnico para empresas y hogares en Per√∫. Descubre nuestro cat√°logo de laptops, computadoras, accesorios, software original, Microsoft 365 y mucho m√°s, siempre con los mejores precios y atenci√≥n personalizada. Ofrecemos asesoramiento tecnol√≥gico, mantenimiento, reciclaje de equipos y soluciones digitales innovadoras para potenciar tu negocio o mejorar tu experiencia en casa. Conf√≠a en eDark para encontrar productos de calidad, soporte profesional y la mejor experiencia de compra online en tecnolog√≠a. ¬°Compra con seguridad y recibe atenci√≥n personalizada de expertos en tecnolog√≠a! Env√≠os a todo el Per√∫. eDark Alpha Technologies ‚Äì Innovaci√≥n, confianza y tecnolog√≠a a tu alcance." />
    <meta name="author" content="eDark EIRL" />
    <title>eDark</title>
    <link rel="icon" type="image/x-icon" href="img/Logo/isotipo_Negro.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="css/styles.css" rel="stylesheet" />
    <link href="css/modern-styles.css" rel="stylesheet" />
    <!-- Google Fonts Orbitron y Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V89W8SCSH1"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9246515570012526"
     crossorigin="anonymous"></script>
     <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1611560592421673"
     crossorigin="anonymous"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-V89W8SCSH1');
    </script>
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AZDxjDScFpQtjWTOUtWKbyN_bDt4OgqaF4eYXlewfBP4-8aqX3PiV8e1GWU6liB2CUXlkA59kJXE7M6R&components=buttons&currency=USD"></script>
    <!-- Apply dark mode immediately from localStorage -->
    <script>
        (function() {
            try {
                if (localStorage.getItem('modoOscuro') === 'true') {
                    document.documentElement.classList.add('modo-oscuro');
                }
            } catch(e) {}
        })();
    </script>
</head>

<script>
fetch('footer.html')
  .then(res => res.text())
  .then(html => {
    document.getElementById('footer').innerHTML = html;
  });

fetch('navbar.html')
  .then(res => res.text())
  .then(html => {
    document.getElementById('navbar').innerHTML = html;
  });
</script>
<body>
    <!-- Navigation-->
    <div id="navbar"></div>
    <!-- Header-->
    <!-- Banner Mejorado eDark -->
    <header class="gradient-bg py-5 position-relative">
      <div class="container px-4 px-lg-5 my-5 d-flex justify-content-center">
        <div class="banner-card text-center text-white p-4 rounded-3 shadow-lg">
          <h1 class="display-4 fw-bold gradient-text mb-1">EDARK</h1>
          <div class="h5 mb-4">Alpha Technologies</div>
          <!-- Carrusel de frases c√©lebres -->
          <div id="frasesCarrusel" class="mx-auto" style="max-width:600px; min-height:60px;">
            <div class="frase-carrusel-texto fs-4 fst-italic"></div>
            <div class="frase-carrusel-autor text-end mt-2" style="font-size:1.1rem;"></div>
          </div>
        </div>
      </div>
        <!-- Flechas del carrusel -->
        <button id="frasePrev" class="btn btn-outline-light position-absolute top-50 start-0 translate-middle-y ms-3 d-none d-md-block" style="z-index:2;" aria-label="Anterior"><i class="bi bi-chevron-left"></i></button>
        <button id="fraseNext" class="btn btn-outline-light position-absolute top-50 end-0 translate-middle-y me-3 d-none d-md-block" style="z-index:2;" aria-label="Siguiente"><i class="bi bi-chevron-right"></i></button>
    </header>

     <!-- Carrusel de Servicios -->
    <div class="container my-4">
      <div id="serviciosCarrusel" class="carousel slide" data-bs-ride="carousel">
        <style>
          #serviciosCarrusel .carousel-indicators { display: none !important; }
        </style>
        <button class="carousel-control-prev" type="button" data-bs-target="#serviciosCarrusel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Anterior</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#serviciosCarrusel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Siguiente</span>
        </button>
        <div class="carousel-inner">
          <div class="carousel-item active">
            <div class="row justify-content-center g-3">
              <div class="col-6 col-md-3">
                <a href="consultoria.html" class="text-decoration-none">
                  <div class="card h-100 text-center shadow-sm area">
                    <div class="card-body">
                      <i class="bi bi-lightbulb icono-servicio mb-2"></i>
                      <h5 class="area-titulo mb-2">Consultor√≠a tecnol√≥gica</h5>
                      <p class="small text-muted">Soluciones y asesor√≠a para empresas y hogares.</p>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-6 col-md-3">
                <a href="soporte.html" class="text-decoration-none">
                  <div class="card h-100 text-center shadow-sm area">
                    <div class="card-body">
                      <i class="bi bi-tools icono-servicio mb-2"></i>
                      <h5 class="area-titulo mb-2">Soporte t√©cnico</h5>
                      <p class="small text-muted">Atenci√≥n presencial y remota, r√°pida y confiable.</p>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-6 col-md-3">
                <a href="mantenimiento.html" class="text-decoration-none">
                  <div class="card h-100 text-center shadow-sm area">
                    <div class="card-body">
                      <i class="bi bi-gear-wide-connected icono-servicio mb-2"></i>
                      <h5 class="area-titulo mb-2">Mantenimiento y reparaci√≥n</h5>
                      <p class="small text-muted">Optimizaci√≥n y reparaci√≥n de computadoras y laptops.</p>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-6 col-md-3">
                <a href="recicla.html" class="text-decoration-none">
                  <div class="card h-100 text-center shadow-sm area">
                    <div class="card-body">
                      <i class="bi bi-recycle icono-servicio mb-2"></i>
                      <h5 class="area-titulo mb-2">Recicla tecnolog√≠a</h5>
                      <p class="small text-muted">Reciclaje responsable de equipos electr√≥nicos.</p>
                    </div>
                  </div>
                </a>
              </div>
            </div>
          </div>
          <div class="carousel-item">
            <div class="row justify-content-center g-3">
              <div class="col-6 col-md-3">
                <a href="asesoramiento-hogar.html" class="text-decoration-none">
                  <div class="card h-100 text-center shadow-sm area">
                    <div class="card-body">
                      <i class="bi bi-house-door icono-servicio mb-2"></i>
                      <h5 class="area-titulo mb-2">Asesoramiento Hogar</h5>
                      <p class="small text-muted">Tecnolog√≠a y seguridad para tu hogar.</p>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-6 col-md-3">
                <a href="asesoramiento-empresa.html" class="text-decoration-none">
                  <div class="card h-100 text-center shadow-sm area">
                    <div class="card-body">
                      <i class="bi bi-building icono-servicio mb-2"></i>
                      <h5 class="area-titulo mb-2">Asesoramiento Empresa</h5>
                      <p class="small text-muted">Soluciones tecnol√≥gicas para tu negocio.</p>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-6 col-md-3">
                <a href="pc-personalizada.html" class="text-decoration-none">
                  <div class="card h-100 text-center shadow-sm area">
                    <div class="card-body">
                      <i class="bi bi-pc-display-horizontal icono-servicio mb-2"></i>
                      <h5 class="area-titulo mb-2">PC Personalizada</h5>
                      <p class="small text-muted">Arma tu computadora a medida.</p>
                    </div>
                  </div>
                </a>
              </div>
            </div>
          </div>
        </div>
        <button class="carousel-control-prev btn btn-outline-light position-absolute top-50 start-0 translate-middle-x ms-3 d-none d-md-block" style="z-index:2;" type="button" data-bs-target="#serviciosCarrusel" data-bs-slide="prev">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button class="carousel-control-next btn btn-outline-light position-absolute top-50 end-0 translate-middle-xx me-3 d-none d-md-block" style="z-index:2;" type="button" data-bs-target="#serviciosCarrusel" data-bs-slide="next">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
    <!-- Secci√≥n de productos -->
    <!-- Filtros y productos -->
    <div class="container-fluid px-5 my-5">
        <div class="row">
            <!-- Filtros -->
            <div class="col-sm-3">
                <div class="sticky-top" style="top: 80px; z-index: 1020;">
                    <div class="container mt-4">
                        <div class="sticky-top bg-white py-2 px-3 shadow-sm" style="top: 80px; z-index: 1030;">
                            <h2>Filtros Aplicados</h2>
                            <div id="selected-filters"></div>
                        </div>
                        <div class="filtros-container" style="max-height: 70vh; overflow-y: auto;">
                            <div class="accordion" id="filterAccordion">
                                <div id="dynamic-filters"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Productos -->
            <div class="col-sm-9">
                <div class="d-flex justify-content-end align-items-center mb-3 flex-wrap gap-2">
                    <label class="me-2 fw-bold" for="ordenarSelect">Ordenar por:</label>
                    <select id="ordenarSelect" class="form-select ordenar-select">
                        <option value="">Por defecto</option>
                        <option value="precio-asc">Precio: Menor a mayor</option>
                        <option value="precio-desc">Precio: Mayor a menor</option>
                        <option value="capacidad-asc">Capacidad: Menor a mayor</option>
                        <option value="capacidad-desc">Capacidad: Mayor a menor</option>
                    </select>
                    <input type="text" id="buscadorProductos" class="form-control ms-2" style="max-width: 250px;" placeholder="Buscar producto...">
                </div>
                <div id="productos" class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center"></div>
                <!-- Loader de productos -->
                <div id="loaderProductos" class="text-center my-5" style="display:none;">
                    <div class="spinner-border text-success role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <div class="mt-2 text-success">Cargando productos...</div>
                </div>
                <!-- Paginaci√≥n -->
                <div id="paginacionProductos" class="mt-4">
                    <!-- Ejemplo de paginaci√≥n -->
                    <nav>
                      <ul class="pagination justify-content-center">
                        <li class="page-item" id="anteriorPagina">
                          <button class="page-link">Anterior</button>
                        </li>
                        <!-- Aqu√≠ van los n√∫meros de p√°gina si quieres -->
                        <li class="page-item" id="siguientePagina">
                          <button class="page-link">Siguiente</button>
                        </li>
                      </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Administrador removido del index; usar Admin Dashboard -->

    <!-- Modal Detalles de Producto -->
    <div class="modal fade" id="modalDetallesProducto" tabindex="-1" aria-labelledby="modalDetallesProductoLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalDetallesProductoLabel">Detalles del Producto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-5 text-center mb-3 mb-md-0">
                <img id="detalleImagen" src="" alt="Imagen producto" class="img-fluid rounded shadow-sm" style="max-height:300px;">
              </div>
              <div class="col-md-7">
                <h4 id="detalleNombre"></h4>
                <p class="mb-1"><strong>Precio:</strong> S/ <span id="detallePrecio"></span></p>
                <p class="mb-1"><strong>Marca:</strong> <span id="detalleMarca"></span></p>
                <p class="mb-1"><strong>Modelo:</strong> <span id="detalleModelo"></span></p>
                <p class="mb-1"><strong>Capacidad:</strong> <span id="detalleCapacidad"></span></p>
                <p class="mb-1"><strong>Dimensi√≥n:</strong> <span id="detalleDimension"></span></p>
                <p class="mb-1"><strong>Categor√≠a:</strong> <span id="detalleCategoria"></span></p>
                <p class="mb-1"><strong>Subcategor√≠a:</strong> <span id="detalleSubcategoria"></span></p>
                <p class="mb-1"><strong>Especificaciones t√©cnicas:</strong> <span id="detalleEspecificaciones" class="small"></span></p>
                <div class="mt-3">
                  <button class="btn btn-success" id="btnAgregarAlCarritoModal"><i class="bi bi-cart-plus"></i> Agregar al carrito</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Carrito de Compras -->
    <div class="modal fade" id="modalCarrito" tabindex="-1" aria-labelledby="modalCarritoLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalCarritoLabel">Carrito de Compras</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div id="carritoContenido"></div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <div>
              <button class="btn btn-danger" id="btnVaciarCarrito">Vaciar Carrito</button>
            </div>
            <div>
              <button class="btn btn-success" id="btnEnviarWhatsapp"><i class="bi bi-whatsapp"></i> WhatsApp</button>
              <!-- PayPal Button Container -->
              <div id="paypal-button-container" class="ms-2 d-inline-block"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer-->
    <div id="footer"></div>
    <!-- Bot√≥n flotante de chat con SVG de gatito negro -->
    <button id="chatbotBtn" style="position:fixed;bottom:30px;right:30px;z-index:1050;" class="btn btn-primary rounded-circle shadow-lg p-0">
      <img src="img/Logo/isotipo_Negro.png" style="width: 50px; height: auto;">
    </button>

    <!-- Modal de chat IA -->
    <div class="modal fade" id="chatbotModal" tabindex="-1" aria-labelledby="chatbotModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-bottom modal-sm" style="position:fixed;bottom:0;right:30px;max-width:350px;margin:0;">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h6 class="modal-title" id="chatbotModalLabel">Chimuelo IA - eDark</h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body" id="chatbotMessages" style="max-height:300px;overflow-y:auto;font-size:0.97em;">
            <div class="text-muted small mb-2">¬°Hola! Soy tu asistente virtual. Mi nombre es Chimuelo. ¬øEn qu√© puedo ayudarte con tu compra?</div>
          </div>
          <div class="modal-footer py-2">
            <input type="text" id="chatbotInput" class="form-control form-control-sm" placeholder="Escribe tu pregunta..." autocomplete="off">
            <button id="chatbotSend" class="btn btn-success btn-sm ms-2">Enviar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
    <!-- Firebase Configuration -->
    <script src="js/firebase-config.js"></script>
    <!-- Core scripts -->
    <script src="js/scripts.js"></script>
    <script>
    // Frases c√©lebres para el carrusel
    const frases = [
        { texto: "La ciencia no es sino una perversi√≥n de s√≠ misma a menos que tenga como objetivo final el mejoramiento de la humanidad.", autor: "Nikola Tesla" },
        { texto: "Cualquier cosa que pueda ser conectada, ser√° conectada.", autor: "Kevin Ashton (Internet de las cosas)" },
        { texto: "La tecnolog√≠a es solo una herramienta. En t√©rminos de motivar a los ni√±os y de conseguir que trabajen juntos, el profesor es lo m√°s importante.", autor: "Bill Gates" },
        { texto: "La mejor manera de predecir el futuro es inventarlo.", autor: "Alan Kay" },
        { texto: "No me asusta que las computadoras lleguen a pensar como los humanos. Me asusta que los humanos piensen como computadoras.", autor: "Sydney J. Harris" },
        { texto: "La innovaci√≥n distingue a un l√≠der de un seguidor.", autor: "Steve Jobs" },
        { texto: "El software es como el sexo: es mejor cuando es libre.", autor: "Linus Torvalds" },
        { texto: "La web es m√°s una invenci√≥n social que t√©cnica. La dise√±√© para que la gente pudiera colaborar y compartir conocimiento.", autor: "Tim Berners-Lee" },
        { texto: "La ciencia de hoy es la tecnolog√≠a del ma√±ana.", autor: "Edward Teller" },
        { texto: "La tecnolog√≠a es mejor cuando une a las personas.", autor: "Matt Mullenweg" },
        { texto: "No es la fe en la tecnolog√≠a. Es la fe en las personas.", autor: "Steve Jobs" },
        { texto: "La tecnolog√≠a mueve el mundo.", autor: "Steve Jobs" },
        { texto: "La tecnolog√≠a es solo tan buena como la gente que la usa.", autor: "An√≥nimo" },
        { texto: "La tecnolog√≠a es una palabra que describe algo que a√∫n no funciona.", autor: "Douglas Adams" },
        { texto: "La imaginaci√≥n es m√°s importante que el conocimiento.", autor: "Albert Einstein" },
        { texto: "La tecnolog√≠a es el arte de organizar el mundo para que no tengamos que experimentarlo.", autor: "Max Frisch" },
        { texto: "El avance de la tecnolog√≠a es basado en hacerla encajar para que no la notes, para que forme parte de la vida cotidiana.", autor: "Bill Gates" },
        { texto: "El mayor enemigo del conocimiento no es la ignorancia, es la ilusi√≥n del conocimiento.", autor: "Stephen Hawking" },
        { texto: "Nunca conf√≠es en un ordenador que no puedas lanzar por una ventana.", autor: "Steve Wozniak" },
        { texto: "El prop√≥sito de la computaci√≥n es la percepci√≥n, la comprensi√≥n y la acci√≥n.", autor: "Marvin Minsky" },
        { texto: "La tecnolog√≠a deber√≠a mejorar tu vida, no convertirse en tu vida.", autor: "Harvey B. Mackay" },
        { texto: "El hardware es lo que hace a una m√°quina r√°pida; el software es lo que hace que una m√°quina lenta.", autor: "Craig Bruce" },
        { texto: "La tecnolog√≠a es cualquier cosa que no estaba cuando naciste.", autor: "Alan Kay" },
        { texto: "El verdadero progreso es el que pone la tecnolog√≠a al alcance de todos.", autor: "Henry Ford" },
        { texto: "La inform√°tica no trata sobre computadoras m√°s que la astronom√≠a sobre telescopios.", autor: "Edsger Dijkstra" }
    ];
    let fraseActual = 0;
    const fraseTexto = () => document.querySelector('.frase-carrusel-texto');
    const fraseAutor = () => document.querySelector('.frase-carrusel-autor');
    function mostrarFrase(idx) {
        fraseTexto().style.opacity = 0;
        fraseAutor().style.opacity = 0;
        setTimeout(() => {
            fraseTexto().textContent = '"' + frases[idx].texto + '"';
            fraseAutor().textContent = '‚Äî ' + frases[idx].autor;
            fraseTexto().style.opacity = 1;
            fraseAutor().style.opacity = 1;
        }, 300);
    }
    function siguienteFrase() {
        fraseActual = (fraseActual + 1) % frases.length;
        mostrarFrase(fraseActual);
    }
    function anteriorFrase() {
        fraseActual = (fraseActual - 1 + frases.length) % frases.length;
        mostrarFrase(fraseActual);
    }
    document.addEventListener('DOMContentLoaded', function() {
        mostrarFrase(fraseActual);
        // Auto-carrusel
        setInterval(siguienteFrase, 7000);
        // Botones
        const prev = document.getElementById('frasePrev');
        const next = document.getElementById('fraseNext');
        if(prev && next) {
            prev.addEventListener('click', anteriorFrase);
            next.addEventListener('click', siguienteFrase);
        }
    });

// Chatbot IA mejorado con Gemini
const chatbotBtn = document.getElementById('chatbotBtn');
const chatbotModal = new bootstrap.Modal(document.getElementById('chatbotModal'));
const chatbotMessages = document.getElementById('chatbotMessages');
const chatbotInput = document.getElementById('chatbotInput');
const chatbotSend = document.getElementById('chatbotSend');

chatbotBtn.addEventListener('click', () => {
    chatbotModal.show();
    setTimeout(() => {
        chatbotInput.focus();
        // Mensaje de bienvenida solo la primera vez
        if (chatbotMessages.children.length === 0) {
            agregarMensajeChat('bot', '¬°Hola! üëã Soy Chimuelo, tu asistente virtual de eDark. ¬øEn qu√© puedo ayudarte hoy?\n\nPuedo ayudarte con:\n‚Ä¢ Informaci√≥n de productos\n‚Ä¢ Recomendaciones tecnol√≥gicas\n‚Ä¢ Precios y disponibilidad\n‚Ä¢ Servicios de eDark');
        }
    }, 500);
});

chatbotSend.addEventListener('click', enviarMensajeChatbot);
chatbotInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        enviarMensajeChatbot();
    }
});

async function obtenerProductosDestacados() {
    try {
        const productos = [];
        const snapshot = await db.collection('productos')
            .where('activo', '==', true)
            .orderBy('nombre')
            .limit(30)
            .get();
        
        snapshot.forEach(doc => {
            const data = doc.data();
            productos.push({
                nombre: data.nombre,
                categoria: data.categoria,
                marca: data.marca,
                descripcion: data.descripcion || '',
                precio: data.precio ? `S/ ${data.precio.toFixed(2)}` : 'Consultar',
                stock: data.stock > 0 ? 'Disponible' : 'Agotado'
            });
        });
        return productos;
    } catch (error) {
        console.error('Error al obtener productos:', error);
        return [];
    }
}

let historialChat = [];

async function enviarMensajeChatbot() {
    const pregunta = chatbotInput.value.trim();
    if (!pregunta) return;
    
    agregarMensajeChat('user', pregunta);
    chatbotInput.value = '';
    chatbotInput.disabled = true;
    chatbotSend.disabled = true;

    historialChat.push({ role: 'user', text: pregunta });

    // Indicador de "pensando..."
    const thinkingId = 'thinking-msg-' + Date.now();
    const divThinking = document.createElement('div');
    divThinking.id = thinkingId;
    divThinking.className = 'text-start mb-2';
    divThinking.innerHTML = `<span class="badge bg-secondary text-break" style="white-space:pre-line;max-width:90%;display:inline-block;">
        <span class="spinner-border spinner-border-sm me-2"></span>Chimuelo est√° pensando...
    </span>`;
    chatbotMessages.appendChild(divThinking);
    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

    try {
        // Obtener productos para contexto
        const productos = await obtenerProductosDestacados();
        const productosTexto = productos.length > 0 
            ? productos.map(p => `‚Ä¢ ${p.nombre} (${p.categoria}${p.marca ? ' - ' + p.marca : ''}): ${p.precio} - ${p.stock}`).join('\n')
            : 'No hay productos disponibles actualmente.';

        // Construir prompt mejorado para Gemini
        const systemPrompt = `Eres Chimuelo, un asistente virtual amigable y experto en tecnolog√≠a para eDark Alpha Technologies, una empresa peruana especializada en:
- Venta de productos tecnol√≥gicos (laptops, PCs, accesorios, software)
- Consultor√≠a tecnol√≥gica empresarial y para hogares
- Soporte t√©cnico profesional
- Mantenimiento y reparaci√≥n de equipos
- Reciclaje de tecnolog√≠a
- PC personalizadas a medida

Tu personalidad es profesional pero cercana, y siempre buscas ayudar al cliente.

PRODUCTOS DISPONIBLES:
${productosTexto}

INSTRUCCIONES:
1. Responde de forma concisa (m√°ximo 3-4 p√°rrafos)
2. Si preguntan por productos, menciona los disponibles con precios
3. Si preguntan por servicios, describe brevemente nuestros servicios
4. Si preguntan algo fuera de tu conocimiento, sugiere contactar con soporte
5. Usa emojis ocasionales para ser m√°s amigable üòä
6. Si el cliente muestra inter√©s, inv√≠talo a contactarnos por WhatsApp: +51 916 907 657

HISTORIAL DE CONVERSACI√ìN:
${historialChat.slice(-6).map(m => `${m.role === 'user' ? 'Cliente' : 'Chimuelo'}: ${m.text}`).join('\n')}

PREGUNTA ACTUAL: ${pregunta}

Responde como Chimuelo:`;

        // Llamada a Gemini API
        const apiKey = 'AIzaSyCv2giDBnjsqNmdnnEylz0NaeEtL8xUZX8';
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: systemPrompt }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 500
                }
            })
        });

        const data = await response.json();
        
        // Remover indicador de pensando
        document.getElementById(thinkingId)?.remove();

        if (data?.candidates?.[0]?.content?.parts?.[0]?.text) {
            const respuesta = data.candidates[0].content.parts[0].text.trim();
            agregarMensajeChat('bot', respuesta);
            historialChat.push({ role: 'bot', text: respuesta });
        } else if (data?.error) {
            throw new Error(data.error.message || 'Error en la API');
        } else {
            throw new Error('Respuesta inv√°lida de la API');
        }

    } catch (error) {
        console.error('Error en chatbot:', error);
        document.getElementById(thinkingId)?.remove();
        
        const mensajeError = error.message.includes('quota') || error.message.includes('429')
            ? '‚ö†Ô∏è Hemos alcanzado el l√≠mite de consultas. Por favor, contacta con nosotros directamente por WhatsApp: +51 916 907 657'
            : '‚ùå Disculpa, tuve un problema al procesar tu mensaje. ¬øPodr√≠as intentarlo de nuevo? Si el problema persiste, escr√≠benos al +51 916 907 657';
        
        agregarMensajeChat('bot', mensajeError);
    } finally {
        chatbotInput.disabled = false;
        chatbotSend.disabled = false;
        chatbotInput.focus();
    }
}

function agregarMensajeChat(remitente, texto) {
    const textoFormateado = texto.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    const div = document.createElement('div');
    div.className = remitente === 'user' ? 'text-end mb-2' : 'text-start mb-2';
    const badgeClass = remitente === 'user' ? 'bg-primary' : 'bg-secondary';
    div.innerHTML = `<span class="badge ${badgeClass} text-break" style="white-space:pre-line;max-width:90%;display:inline-block;text-align:left;">${textoFormateado}</span>`;
    chatbotMessages.appendChild(div);
    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
}

    function renderizarPaginacion(paginaActual, totalPaginas) {
        let paginacionHTML = `
        <nav>
          <ul class="pagination justify-content-center">
            <li class="page-item${paginaActual === 1 ? ' disabled' : ''}">
              <button class="page-link" id="primeraPagina" aria-label="Primera">&laquo;</button>
            </li>
            <li class="page-item${paginaActual === 1 ? ' disabled' : ''}">
              <button class="page-link" id="anteriorPagina" aria-label="Anterior">&lsaquo;</button>
            </li>
        `;

        // N√∫meros de p√°gina (m√°ximo 5 visibles)
        let start = Math.max(1, paginaActual - 2);
        let end = Math.min(totalPaginas, paginaActual + 2);
        if (paginaActual <= 3) end = Math.min(5, totalPaginas);
        if (paginaActual >= totalPaginas - 2) start = Math.max(1, totalPaginas - 4);

        for (let i = start; i <= end; i++) {
            paginacionHTML += `
            <li class="page-item${i === paginaActual ? ' active' : ''}">
              <button class="page-link pagina-numero" data-pagina="${i}">${i}</button>
            </li>`;
        }

        paginacionHTML += `
            <li class="page-item${paginaActual === totalPaginas ? ' disabled' : ''}">
              <button class="page-link" id="siguientePagina" aria-label="Siguiente">&rsaquo;</button>
            </li>
            <li class="page-item${paginaActual === totalPaginas ? ' disabled' : ''}">
              <button class="page-link" id="ultimaPagina" aria-label="√öltima">&raquo;</button>
            </li>
          </ul>
        </nav>
        `;
        document.getElementById('paginacionProductos').innerHTML = paginacionHTML;

        // Listeners
        document.getElementById('primeraPagina').onclick = function() {
            if (paginaActual > 1) cargarProductos(1);
        };
        document.getElementById('anteriorPagina').onclick = function() {
            if (paginaActual > 1) cargarProductos(paginaActual - 1);
        };
        document.getElementById('siguientePagina').onclick = function() {
            if (paginaActual < totalPaginas) cargarProductos(paginaActual + 1);
        };
        document.getElementById('ultimaPagina').onclick = function() {
            if (paginaActual < totalPaginas) cargarProductos(totalPaginas);
        };
        document.querySelectorAll('.pagina-numero').forEach(btn => {
            btn.onclick = function() {
                const pagina = parseInt(this.getAttribute('data-pagina'));
                if (pagina !== paginaActual) cargarProductos(pagina);
            };
        });
    }

    // Llama a renderizarPaginacion(paginaActual, totalPaginas) cada vez que cambias de p√°gina
    </script>

</body>
</html>

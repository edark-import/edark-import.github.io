<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Catálogo de productos eDark" />
    <meta name="author" content="eDark EIRL" />
    <title>eDark</title>
    <link rel="icon" type="image/x-icon" href="img/Logo/isotipo_Negro.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="css/styles.css" rel="stylesheet" />
    <style>
        .filtros-container .form-range::-webkit-slider-thumb { background: #00adb5; }
        .filtros-container .form-range::-moz-range-thumb { background: #00adb5; }
        .filtros-container .form-range::-ms-thumb { background: #00adb5; }
        .filtros-container .form-range:focus::-webkit-slider-thumb { box-shadow: 0 0 0 0.25rem #00adb555; }
        .ordenar-select { max-width: 220px; }
        .dropdown-submenu { position: relative; }
        .dropdown-submenu > .dropdown-menu { top: 0; left: 100%; margin-left: 0.1rem; margin-right: 0.1rem; }

        /* Modo oscuro */
        body.modo-oscuro {
            background-color: #181a1b !important;
            color: #e0e0e0 !important;
        }
        body.modo-oscuro .bg-light {
            background-color: #23272b !important;
        }
        body.modo-oscuro .navbar, body.modo-oscuro .dropdown-menu {
            background-color: #23272b !important;
            color: #e0e0e0 !important;
        }
        body.modo-oscuro .card {
            background-color: #23272b !important;
            color: #e0e0e0 !important;
            border-color: #444 !important;
        }
        body.modo-oscuro .modal-content {
            background-color: #23272b !important;
            color: #e0e0e0 !important;
        }
        body.modo-oscuro .form-control, body.modo-oscuro .form-select {
            background-color: #23272b !important;
            color: #e0e0e0 !important;
            border-color: #444 !important;
        }
        body.modo-oscuro .accordion-button {
            background-color: #23272b !important;
            color: #e0e0e0 !important;
        }
        body.modo-oscuro .accordion-item {
            background-color: #23272b !important;
            color: #e0e0e0 !important;
        }
        body.modo-oscuro .bg-dark {
            background-color: #181a1b !important;
        }
        body.modo-oscuro .bg-white {
            background-color: #23272b !important;
        }
        body.modo-oscuro .pagination .page-link {
            background-color: #23272b !important;
            color: #e0e0e0 !important;
            border-color: #444 !important;
        }
        body.modo-oscuro .page-item.active .page-link {
            background-color: #00adb5 !important;
            color: #fff !important;
            border-color: #00adb5 !important;
        }
        body.modo-oscuro .btn-outline-dark {
            color: #e0e0e0 !important;
            border-color: #e0e0e0 !important;
        }
        body.modo-oscuro .btn-outline-dark:hover {
            background-color: #00adb5 !important;
            color: #fff !important;
            border-color: #00adb5 !important;
        }
        body.modo-oscuro .shadow-sm {
            box-shadow: 0 .125rem .25rem rgba(0,0,0,.5)!important;
        }
    </style>
</head>
<script>
fetch('footer.html')
  .then(res => res.text())
  .then(html => {
    document.getElementById('footer').innerHTML = html;
  });
</script>
<body>
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" href="index.html">
                <img width="80" class="d-flex" alt="edark_logo" src="img/Logo/logo_2.png">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                    <li class="nav-item"><a class="nav-link active" aria-current="page" href="index.html">Inicio</a></li> 
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Servicios</a>
                        <ul class="dropdown-menu dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="consultoria.html">Consultoría tecnológica</a></li>
                            <li><a class="dropdown-item" href="soporte.html">Soporte técnico</a></li>
                            <li class="dropdown-submenu">
                                <a class="dropdown-item dropdown-toggle" href="#" id="asesoramientoDropdown" data-bs-toggle="dropdown" aria-expanded="false">Asesoramiento Tecnológico</a>
                                <ul class="dropdown-menu dropdown-menu" aria-labelledby="asesoramientoDropdown">
                                    <li><a class="dropdown-item" href="asesoramiento-hogar.html">Hogar</a></li>
                                    <li><a class="dropdown-item" href="asesoramiento-empresa.html">Empresa</a></li>
                                </ul>
                            </li>
                            <li><a class="dropdown-item" href="mantenimiento.html">Mantenimiento y reparación</a></li>
                            <li><a class="dropdown-item" href="recicla.html">Recicla tecnología</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="nosotros.html">Nosotros</a></li>
                    <li class="nav-item"><a class="nav-link" href="contactanos.html">Contáctanos</a></li>
                </ul>
                <form class="d-flex align-items-center" id="adminNav">
                    <button class="btn btn-outline-light" type="button" id="tipoCambioBtn" disabled style="min-width:120px">
                        <i class="bi-currency-exchange me-1"></i>
                        <span id="tipoCambioText">S/ 3.8</span>
                    </button>
                    <!-- Botón en navbar -->
                    <button class="btn btn-outline-primary ms-2" type="button" id="adminBtn" data-bs-toggle="modal" data-bs-target="#loginModal">
                        <i class="bi bi-person-fill"></i>  
                    </button>
                    <!-- Botón de Carrito en Navbar -->
                    <button class="btn btn-success ms-2 position-relative" type="button" id="cartBtn">
                        <i class="bi bi-cart"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartCount" style="font-size:0.8em;">0</span>
                    </button>
                    <span id="userEmail" class="ms-2 text-primary d-none"></span>
                    <button class="btn btn-danger ms-2 d-none" type="button" id="logoutBtnNav">
                        Cerrar Sesión
                    </button>
                    <!-- Switch modo oscuro/claro -->
                    <div class="form-check form-switch ms-3">
                        <input class="form-check-input" type="checkbox" id="modoOscuroSwitch">
                        <label class="form-check-label text-light" for="modoOscuroSwitch" id="modoOscuroLabel"><i class="bi bi-moon"></i></label>
                    </div>
                </form>
            </div>
        </div>
    </nav>
    <!-- Header-->
    <header class="bg-dark py-5">
        <div class="container px-4 px-lg-5 my-5">
            <div class="text-center text-white">
                <h1 class="display-4 fw-bolder">Compra con eDark</h1>
                <p class="lead fw-normal text-white-50 mb-0">Encuenta tus productos favoritos del lado oscuro</p>
            </div>
        </div>
    </header>

    <!-- Filtros y productos -->
    <div class="container-fluid px-5 my-5">
        <div class="row">
            <!-- Filtros -->
            <div class="col-sm-3">
                <div class="sticky-top" style="top: 80px; z-index: 1020;">
                    <div class="container mt-4">
                        <div class="sticky-top bg-white py-2 px-3 shadow-sm" style="top: 80px; z-index: 1030;">
                            <h2>Filtros Aplicados</h2>
                            <div id="selected-filters"></div>
                        </div>
                        <div class="filtros-container" style="max-height: 70vh; overflow-y: auto;">
                            <div class="accordion" id="filterAccordion">
                                <div id="dynamic-filters"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Productos -->
            <div class="col-sm-9">
                <div class="d-flex justify-content-end align-items-center mb-3 flex-wrap gap-2">
                    <label class="me-2 fw-bold" for="ordenarSelect">Ordenar por:</label>
                    <select id="ordenarSelect" class="form-select ordenar-select">
                        <option value="">Por defecto</option>
                        <option value="precio-asc">Precio: Menor a mayor</option>
                        <option value="precio-desc">Precio: Mayor a menor</option>
                        <option value="capacidad-asc">Capacidad: Menor a mayor</option>
                        <option value="capacidad-desc">Capacidad: Mayor a menor</option>
                    </select>
                    <input type="text" id="buscadorProductos" class="form-control ms-2" style="max-width: 250px;" placeholder="Buscar producto...">
                </div>
                <div id="productos" class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center"></div>
                <!-- Paginación -->
                <div id="paginacionProductos" class="mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Panel de Login y Administrador -->
    <div class="container my-5 d-none" id="adminContainer">
        <h3>Panel Administrador</h3>
        <button id="logoutBtn" class="btn btn-danger mb-3">Cerrar Sesión</button>
        <form id="adminForm" class="mb-3">
            <input type="text" id="nombre" placeholder="Nombre del producto" required class="form-control mb-2">
            <input type="number" id="precioCompra" placeholder="Precio de compra" required class="form-control mb-2" step="any">
            <div class="input-group mb-2">
              <label class="input-group-text" for="monedaCompra">Moneda</label>
              <select id="monedaCompra" class="form-select">
                <option value="USD" selected>Dólares (USD)</option>
                <option value="PEN">Soles (S/)</option>
              </select>
            </div>
            <div class="alert alert-info py-2 px-3 mb-2" id="infoTipoCambio" style="font-size:0.95em;">
              <strong>Tipo de cambio SUNAT:</strong> <span id="tipoCambioValor">-</span> <span id="tipoCambioMoneda">USD/PEN</span> <span id="tipoCambioFecha"></span> <span id="tipoCambioOrigen"></span>
            </div>
            <input type="text" id="imagen" placeholder="URL de la imagen" required class="form-control mb-2">
            <input type="text" id="categoria" placeholder="Categoría" required class="form-control mb-2">
            <input type="text" id="subcategoria" placeholder="Subcategoría" required class="form-control mb-2">
            <input type="text" id="marca" placeholder="Marca" required class="form-control mb-2">
            <input type="text" id="capacidad" placeholder="Capacidad" class="form-control mb-2">
            <input type="text" id="modelo" placeholder="Modelo" class="form-control mb-2">
            <input type="text" id="dimension" placeholder="Dimensión" class="form-control mb-2">
            <input type="text" id="precioVenta" placeholder="Precio de venta (S/)" class="form-control mb-2" readonly>
            <button type="submit" class="btn btn-primary">Agregar Producto</button>
        </form>
    </div>

    <!-- Modal de Login Administrador -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Iniciar Sesión Administrador</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <form id="loginForm">
              <input type="email" id="loginEmail" placeholder="Correo" required class="form-control mb-2">
              <input type="password" id="loginPassword" placeholder="Contraseña" required class="form-control mb-2">
              <button type="submit" class="btn btn-primary">Ingresar</button>
              <div id="loginError" class="text-danger mt-2"></div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Detalles de Producto -->
    <div class="modal fade" id="modalDetallesProducto" tabindex="-1" aria-labelledby="modalDetallesProductoLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalDetallesProductoLabel">Detalles del Producto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-5 text-center mb-3 mb-md-0">
                <img id="detalleImagen" src="" alt="Imagen producto" class="img-fluid rounded shadow-sm" style="max-height:300px;">
              </div>
              <div class="col-md-7">
                <h4 id="detalleNombre"></h4>
                <p class="mb-1"><strong>Precio:</strong> S/ <span id="detallePrecio"></span></p>
                <p class="mb-1"><strong>Marca:</strong> <span id="detalleMarca"></span></p>
                <p class="mb-1"><strong>Modelo:</strong> <span id="detalleModelo"></span></p>
                <p class="mb-1"><strong>Capacidad:</strong> <span id="detalleCapacidad"></span></p>
                <p class="mb-1"><strong>Dimensión:</strong> <span id="detalleDimension"></span></p>
                <p class="mb-1"><strong>Categoría:</strong> <span id="detalleCategoria"></span></p>
                <p class="mb-1"><strong>Subcategoría:</strong> <span id="detalleSubcategoria"></span></p>
                <div class="mt-3">
                  <button class="btn btn-success" id="btnAgregarAlCarritoModal"><i class="bi bi-cart-plus"></i> Agregar al carrito</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Carrito de Compras -->
    <div class="modal fade" id="modalCarrito" tabindex="-1" aria-labelledby="modalCarritoLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalCarritoLabel">Carrito de Compras</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div id="carritoContenido"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-danger" id="btnVaciarCarrito">Vaciar Carrito</button>
            <button class="btn btn-success" id="btnEnviarWhatsapp"><i class="bi bi-whatsapp"></i> Enviar pedido por WhatsApp</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer-->
    <div id="footer"></div>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script>
    // --- CONFIGURACIÓN FIREBASE Y LÓGICA PRINCIPAL (SOLO UNA VEZ) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBXbqr_NrwqcfDvvk1mqN9GKKPaRv4uvx4",
        authDomain: "edark-proyect.firebaseapp.com",
        projectId: "edark-proyect",
        storageBucket: "edark-proyect.appspot.com",
        messagingSenderId: "705929141287",
        appId: "1:705929141287:web:f16389625de554d6790202",
        measurementId: "G-V89W8SCSH1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- SEGURIDAD Y VALIDACIONES ---
    function sanitize(str) {
        return String(str).replace(/[<>&"'`]/g, c => ({
            '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;', '`': '&#96;'
        })[c]);
    }
    function safeImageUrl(url) {
        try {
            const u = new URL(url, window.location.origin);
            if (u.protocol === "http:" || u.protocol === "https:") return url;
        } catch { }
        return 'https://dummyimage.com/450x300/dee2e6/6c757d.jpg';
    }
    // Forzar HTTPS
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        location.href = 'https://' + location.hostname + location.pathname + location.search;
    }
    // Protección clickjacking
    if (window.top !== window.self) window.top.location = window.self.location;

    // --- VARIABLES GLOBALES ---
    let tipoCambioGlobal = 3.8; // Tipo de cambio SUNAT global
    // Número de WhatsApp para pedidos. Cambia aquí tu número en formato internacional, sin espacios ni signos.
    const phone = '51916907657'; // <-- Cambia este número por el tuyo
    // let productosCache = [];
    let paginaActual = 1;
    const productosPorPagina = 15;
    let unsubscribe = null;
    let textoBusqueda = '';

    // --- OBTENER Y MOSTRAR TIPO DE CAMBIO SUNAT UNA SOLA VEZ ---
    async function inicializarTipoCambioSunat() {
        try {
            const res = await fetch('https://corsproxy.io/?https://api.apis.net.pe/v1/tipo-cambio-sunat');
            const data = await res.json();
            if (data && data.venta) {
                tipoCambioGlobal = parseFloat(data.venta);
                document.getElementById('tipoCambioValor').textContent = tipoCambioGlobal.toFixed(3);
                document.getElementById('tipoCambioMoneda').textContent = `${data.moneda ? data.moneda : 'USD/PEN'}`;
                document.getElementById('tipoCambioFecha').textContent = data.fecha ? `(${data.fecha})` : '';
                document.getElementById('tipoCambioOrigen').textContent = data.origen ? `- ${data.origen}` : '';
            }
        } catch (e) {
            tipoCambioGlobal = 3.8;
            document.getElementById('tipoCambioValor').textContent = tipoCambioGlobal.toFixed(2);
            document.getElementById('tipoCambioMoneda').textContent = 'USD/PEN';
            document.getElementById('tipoCambioFecha').textContent = '';
            document.getElementById('tipoCambioOrigen').textContent = '- Local';
        }
        document.getElementById('tipoCambioText').textContent = `S/ ${tipoCambioGlobal.toFixed(2)}`;
    }
    document.addEventListener('DOMContentLoaded', async function () {
        await inicializarTipoCambioSunat();
        await cargarFiltrosDinamicos();
        renderBadges();
        mostrarProductos();
    });

    // --- FUNCIONES DE FILTROS Y PAGINACIÓN ---
    // Filtros anidados y filtro de precio
    const camposFiltro = [
        { campo: "categoria", label: "Categoría" },
        { campo: "subcategoria", label: "Subcategoría", parent: "categoria" },
        { campo: "marca", label: "Marca" },
        { campo: "capacidad", label: "Capacidad" },
        { campo: "modelo", label: "Modelo" },
        { campo: "dimension", label: "Dimensión" }
    ];

    let valoresFiltro = {};
    let subcategoriasPorCategoria = {};
    let filtrosSeleccionados = {};
    camposFiltro.forEach(f => filtrosSeleccionados[f.campo] = []);
    // Filtro de precio
    let precioMin = 0, precioMax = 0, precioFiltroMin = 0, precioFiltroMax = 0;

    // 1. Obtiene todos los valores únicos de cada campo desde Firestore
    async function cargarFiltrosDinamicos() {
        const snapshot = await db.collection('productos').get();
        valoresFiltro = {};
        subcategoriasPorCategoria = {};
        camposFiltro.forEach(f => valoresFiltro[f.campo] = new Set());
        let precios = [];
        snapshot.forEach(doc => {
            const prod = doc.data();
            camposFiltro.forEach(f => {
                if (prod[f.campo]) valoresFiltro[f.campo].add(prod[f.campo]);
            });
            // Relaciona subcategoría con categoría
            if (prod.categoria && prod.subcategoria) {
                if (!subcategoriasPorCategoria[prod.categoria]) subcategoriasPorCategoria[prod.categoria] = new Set();
                subcategoriasPorCategoria[prod.categoria].add(prod.subcategoria);
            }
            if (typeof prod.precio === "number") precios.push(prod.precio);
        });

        // Filtro de precio
        precioMin = Math.min(...precios);
        precioMax = Math.max(...precios);
        precioFiltroMin = precioMin;
        precioFiltroMax = precioMax;

        // Genera el HTML de los filtros
        let html = '';

        // Filtro de precio
        html += `
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#filter-precio">
                    Precio (S/)
                </button>
            </h2>
            <div id="filter-precio" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <div class="mb-2">
                        <label for="precioMin" class="form-label">Mínimo: <span id="precioMinLabel">${precioMin}</span></label>
                        <input type="range" class="form-range" min="${precioMin}" max="${precioMax}" value="${precioMin}" id="precioMin">
                    </div>
                    <div>
                        <label for="precioMax" class="form-label">Máximo: <span id="precioMaxLabel">${precioMax}</span></label>
                        <input type="range" class="form-range" min="${precioMin}" max="${precioMax}" value="${precioMax}" id="precioMax">
                    </div>
                </div>
            </div>
        </div>
        `;

        // Categoría y subcategoría anidados
        html += `
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#filter-categoria">
                    Categoría
                </button>
            </h2>
            <div id="filter-categoria" class="accordion-collapse collapse">
                <div class="accordion-body" id="categoria-body">
        `;
        Array.from(valoresFiltro["categoria"]).sort().forEach(categoria => {
            const catId = `filter-categoria-${categoria.replace(/[^a-zA-Z0-9]/g, '')}`;
            html += `
                <div class="form-check mb-1">
                    <input class="form-check-input filter-checkbox" type="checkbox" value="${categoria}" id="${catId}" data-campo="categoria">
                    <label class="form-check-label fw-bold" for="${catId}">${categoria}</label>
                </div>
            `;
            // Subcategorías anidadas
            if (subcategoriasPorCategoria[categoria]) {
                Array.from(subcategoriasPorCategoria[categoria]).sort().forEach(subcat => {
                    const subcatId = `filter-subcategoria-${subcat.replace(/[^a-zA-Z0-9]/g, '')}-cat-${categoria.replace(/[^a-zA-Z0-9]/g, '')}`;
                    html += `
                        <div class="form-check ms-4">
                            <input class="form-check-input filter-checkbox" type="checkbox" value="${subcat}" id="${subcatId}" data-campo="subcategoria" data-parent="${categoria}">
                            <label class="form-check-label" for="${subcatId}">${subcat}</label>
                        </div>
                    `;
                });
            }
        });
        html += `</div></div></div>`;

        // Resto de filtros
        ["marca", "capacidad", "modelo", "dimension"].forEach(campo => {
            html += `
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#filter-${campo}">
                        ${camposFiltro.find(f => f.campo === campo).label}
                    </button>
                </h2>
                <div id="filter-${campo}" class="accordion-collapse collapse">
                    <div class="accordion-body">
            `;
            Array.from(valoresFiltro[campo]).sort().forEach(valor => {
                const id = `filter-${campo}-${valor.replace(/[^a-zA-Z0-9]/g, '')}`;
                html += `
                    <div class="form-check">
                        <input class="form-check-input filter-checkbox" type="checkbox" value="${valor}" id="${id}" data-campo="${campo}">
                        <label class="form-check-label" for="${id}">${valor}</label>
                    </div>
                `;
            });
            html += `</div></div></div>`;
        });

        document.getElementById('dynamic-filters').innerHTML = html;

        // Eventos para filtros
        document.querySelectorAll('.filter-checkbox').forEach(cb => {
            cb.addEventListener('change', function () {
                const campo = this.dataset.campo;
                const valor = this.value;
                if (this.checked) {
                    if (!filtrosSeleccionados[campo].includes(valor)) {
                        filtrosSeleccionados[campo].push(valor);
                    }
                } else {
                    filtrosSeleccionados[campo] = filtrosSeleccionados[campo].filter(v => v !== valor);
                }
                renderBadges();
                mostrarProductos();
            });
        });

        // Filtro de precio
        document.getElementById('precioMin').addEventListener('input', function () {
            let min = parseInt(this.value);
            let max = parseInt(document.getElementById('precioMax').value);
            if (min > max) {
                min = max;
                this.value = min;
            }
            precioFiltroMin = min;
            document.getElementById('precioMinLabel').textContent = min;
            mostrarProductos();
        });
        document.getElementById('precioMax').addEventListener('input', function () {
            let max = parseInt(this.value);
            let min = parseInt(document.getElementById('precioMin').value);
            if (max < min) {
                max = min;
                this.value = max;
            }
            precioFiltroMax = max;
            document.getElementById('precioMaxLabel').textContent = max;
            mostrarProductos();
        });
    }

    function renderBadges() {
        const container = document.getElementById('selected-filters');
        container.innerHTML = '';
        camposFiltro.forEach(f => {
            filtrosSeleccionados[f.campo].forEach(valor => {
                let id;
                if (f.campo === "subcategoria") {
                    // Busca la categoría asociada para el id
                    let cat = null;
                    for (const c in subcategoriasPorCategoria) {
                        if (subcategoriasPorCategoria[c].has(valor)) {
                            cat = c;
                            break;
                        }
                    }
                    id = `filter-subcategoria-${valor.replace(/[^a-zA-Z0-9]/g, '')}-cat-${cat ? cat.replace(/[^a-zA-Z0-9]/g, '') : ''}`;
                } else {
                    id = `filter-${f.campo}-${valor.replace(/[^a-zA-Z0-9]/g, '')}`;
                }
                container.innerHTML += `<span class="mt-2 badge bg-primary me-2 filter-badge" data-id="${id}">${valor} <button type="button" class="btn-close btn-close-white ms-1 remove-filter" aria-label="Close" data-id="${id}" data-campo="${f.campo}" data-valor="${valor}"></button></span>`;
            });
        });
        // Badge de precio
        if (precioFiltroMin > precioMin || precioFiltroMax < precioMax) {
            container.innerHTML += `<span class="mt-2 badge bg-info me-2 filter-badge" data-id="precio-badge">S/${precioFiltroMin} - S/${precioFiltroMax} <button type="button" class="btn-close btn-close-white ms-1 remove-filter" aria-label="Close" data-id="precio-badge" data-campo="precio"></button></span>`;
        }
    }

    document.getElementById('selected-filters').addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-filter')) {
            const campo = e.target.dataset.campo;
            const valor = e.target.dataset.valor;
            const id = e.target.dataset.id;
            if (campo === "precio") {
                // Reset precio
                precioFiltroMin = precioMin;
                precioFiltroMax = precioMax;
                document.getElementById('precioMin').value = precioMin;
                document.getElementById('precioMax').value = precioMax;
                document.getElementById('precioMinLabel').textContent = precioMin;
                document.getElementById('precioMaxLabel').textContent = precioMax;
            } else {
                const cb = document.getElementById(id);
                if (cb) cb.checked = false;
                filtrosSeleccionados[campo] = filtrosSeleccionados[campo].filter(v => v !== valor);
            }
            renderBadges();
            mostrarProductos();
        }
    });

    // --- MOSTRAR PRODUCTOS CON PAGINACIÓN Y SEGURIDAD ---
    function mostrarProductos() {
        if (unsubscribe) unsubscribe();
        unsubscribe = db.collection('productos').onSnapshot(snapshot => {
            productosCache = [];
            snapshot.forEach(doc => {
                productosCache.push(doc.data());
            });
            paginaActual = 1;
            renderProductos();
        });
    }

    // Modifica renderProductosPaginados para filtrar por búsqueda
    function renderProductosPaginados() {
        let productos = productosCache.filter(productoCoincideFiltros);
        // ...ordenamiento y paginación...
        const orden = document.getElementById('ordenarSelect').value;
        if (orden === "precio-asc") {
            productos.sort((a, b) => (a.precio || 0) - (b.precio || 0));
        } else if (orden === "precio-desc") {
            productos.sort((a, b) => (b.precio || 0) - (a.precio || 0));
        } else if (orden === "capacidad-asc") {
            productos.sort((a, b) => parseCapacidad(a.capacidad) - parseCapacidad(b.capacidad));
        } else if (orden === "capacidad-desc") {
            productos.sort((a, b) => parseCapacidad(b.capacidad) - parseCapacidad(a.capacidad));
        }
        const totalPaginas = Math.ceil(productos.length / productosPorPagina);
        if (paginaActual > totalPaginas) paginaActual = totalPaginas || 1;
        const inicio = (paginaActual - 1) * productosPorPagina;
        const fin = inicio + productosPorPagina;
        const productosPagina = productos.slice(inicio, fin);
        const contenedor = document.getElementById('productos');
        contenedor.innerHTML = '';
        productosPagina.forEach((prod, idx) => {
            contenedor.innerHTML += `
                <div class="col mb-5">
                    <div class="card h-100">
                        <img class="card-img-top" src="${safeImageUrl(prod.imagen || '')}" alt="${sanitize(prod.nombre)}" />
                        <div class="card-body p-4">
                            <div class="text-center">
                                <h5 class="fw-bolder">${sanitize(prod.nombre || 'Producto')}</h5>
                                <div class="d-flex justify-content-center small text-warning mb-2">
                                    <div class="bi-star-fill"></div>
                                    <div class="bi-star-fill"></div>
                                    <div class="bi-star-fill"></div>
                                    <div class="bi-star-fill"></div>
                                    <div class="bi-star-fill"></div>
                                </div>
                                s/${sanitize(prod.precio || '---')}
                            </div>
                        </div>
                        <div class="card-footer p-4 pt-0 border-top-0 bg-transparent">
                            <div class="text-center"><button class="btn btn-outline-dark mt-auto btn-ver-detalles" data-idx="${productosCache.indexOf(prod)}">Ver Detalles</button></div>
                        </div>
                    </div>
                </div>
            `;
        });
        if (contenedor.innerHTML === '') {
            contenedor.innerHTML = `<div class="col-12 text-center text-muted py-5">No hay productos que coincidan con los filtros seleccionados.</div>`;
        }
        renderPaginacion(totalPaginas);
        asignarEventosProductos();
    }
    // Si tienes renderProductos sin paginación, igual:
    function renderProductos() {
        renderProductosPaginados();
    }
    // --- FUNCIÓN PARA RENDERIZAR PAGINACIÓN ---
function renderPaginacion(totalPaginas) {
    const paginacionContainer = document.getElementById('paginacionProductos');
    if (!paginacionContainer) return;
    paginacionContainer.innerHTML = '';
    if (totalPaginas <= 1) return;
    let html = '<nav aria-label="Paginación de productos"><ul class="pagination justify-content-center">';
    // Botón anterior
    html += `<li class="page-item${paginaActual === 1 ? ' disabled' : ''}"><button class="page-link" data-page="${paginaActual - 1}" ${paginaActual === 1 ? 'tabindex="-1" aria-disabled="true"' : ''}>Anterior</button></li>`;
    // Números de página
    for (let i = 1; i <= totalPaginas; i++) {
        html += `<li class="page-item${paginaActual === i ? ' active' : ''}"><button class="page-link" data-page="${i}">${i}</button></li>`;
    }
    // Botón siguiente
    html += `<li class="page-item${paginaActual === totalPaginas ? ' disabled' : ''}"><button class="page-link" data-page="${paginaActual + 1}" ${paginaActual === totalPaginas ? 'tabindex="-1" aria-disabled="true"' : ''}>Siguiente</button></li>`;
    html += '</ul></nav>';
    paginacionContainer.innerHTML = html;
    // Eventos de paginación
    paginacionContainer.querySelectorAll('.page-link').forEach(btn => {
        btn.addEventListener('click', function() {
            const page = parseInt(this.dataset.page);
            if (!isNaN(page) && page >= 1 && page <= totalPaginas && page !== paginaActual) {
                paginaActual = page;
                renderProductos();
            }
        });
    });
}
// --- FUNCIÓN PARA ORDENAR POR CAPACIDAD (asegúrate de que esté antes de renderProductosPaginados) ---
    function parseCapacidad(valor) {
        if (!valor) return 0;
        valor = valor.toString().trim().toUpperCase();
        // Extrae número y unidad
        const match = valor.match(/([\d,.]+)\s*(TB|GB|MB|KB)?/i);
        if (!match) return 0;
        let num = parseFloat(match[1].replace(',', '.'));
        let unidad = match[2] || 'GB';
        if (isNaN(num)) return 0;
        switch (unidad) {
            case 'TB': return num * 1024;
            case 'GB': return num;
            case 'MB': return num / 1024;
            case 'KB': return num / (1024 * 1024);
            default: return num;
        }
    }

    // --- EVENTO PARA ORDENAR ---
    document.getElementById('ordenarSelect').addEventListener('change', function() {
        renderProductos();
    });

    // --- FIRESTORE: CARGA Y ACTUALIZA PRODUCTOS ---
    function mostrarProductos() {
        if (unsubscribe) unsubscribe();
        unsubscribe = db.collection('productos').onSnapshot(snapshot => {
            productosCache = [];
            snapshot.forEach(doc => {
                productosCache.push(doc.data());
            });
            paginaActual = 1;
            renderProductos();
        });
    }

    // --- REGLA DE SEGURIDAD FIRESTORE (configura en la consola de Firebase) ---
    /*
    service cloud.firestore {
      match /databases/{database}/documents {
        match /productos/{document} {
          allow read: if true;
          allow write: if request.auth != null && request.auth.token.admin == true;
        }
      }
    }
    */

    // Login
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    document.getElementById('loginError').textContent = '';
                    // Cierra el modal si es necesario
                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    if (loginModal) loginModal.hide();
                })
                .catch(err => {
                    document.getElementById('loginError').textContent = 'Usuario o contraseña incorrectos';
                });
        });
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', function() {
        auth.signOut();
    });

    // Calcula y muestra el precio de venta automáticamente
    // Usa tipoCambioGlobal en vez de llamar a la API cada vez

    document.getElementById('precioCompra').addEventListener('input', calcularPrecioVenta);
    document.getElementById('monedaCompra').addEventListener('change', calcularPrecioVenta);
    function calcularPrecioVenta() {
        const precioCompra = parseFloat(document.getElementById('precioCompra').value);
        const moneda = document.getElementById('monedaCompra').value;
        if (isNaN(precioCompra) || precioCompra <= 0) {
            document.getElementById('precioVenta').value = '';
            return;
        }
        let precioVenta;
        if (moneda === 'USD') {
            precioVenta = precioCompra * tipoCambioGlobal * 1.18 * 1.45;
        } else {
            precioVenta = precioCompra * 1.18 * 1.45;
        }
        precioVenta = Math.ceil(precioVenta);
        document.getElementById('precioVenta').value = precioVenta;
    }

    document.getElementById('adminForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const nombre = document.getElementById('nombre').value.trim();
        const precioCompra = parseFloat(document.getElementById('precioCompra').value);
        const precioVenta = parseFloat(document.getElementById('precioVenta').value);
        const imagen = document.getElementById('imagen').value.trim();
        const categoria = document.getElementById('categoria').value.trim();
        const subcategoria = document.getElementById('subcategoria').value.trim();
        const marca = document.getElementById('marca').value.trim();
        const capacidad = document.getElementById('capacidad').value.trim();
        const modelo = document.getElementById('modelo').value.trim();
        const dimension = document.getElementById('dimension').value.trim();
        const moneda = document.getElementById('monedaCompra').value;

        // Validación básica
        if (!nombre || isNaN(precioCompra) || precioCompra <= 0 || isNaN(precioVenta) || precioVenta <= 0 || !imagen || !categoria || !subcategoria || !marca) {
            alert('Por favor, completa todos los campos obligatorios y asegúrate de que los precios sean válidos.');
            return;
        }

        try {
            await db.collection('productos').add({
                nombre,
                precioCompra,
                precio: precioVenta, // este es el precio de venta en soles
                imagen,
                categoria,
                subcategoria,
                marca,
                capacidad,
                modelo,
                dimension,
                moneda
            });
            this.reset();
            document.getElementById('precioVenta').value = '';
            document.getElementById('monedaCompra').value = 'USD';
        } catch (err) {
            alert('Error al registrar el producto. Intenta nuevamente.');
        }
    });

    // Mostrar/ocultar panel según autenticación
    auth.onAuthStateChanged(user => {
        const adminContainer = document.getElementById('adminContainer');
        if (user) {
            adminContainer.classList.remove('d-none');
            // Opcional: Cerrar el modal de login
            const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
            if (loginModal) loginModal.hide();
        } else {
            adminContainer.classList.add('d-none');
        }
    });

    // Botón cerrar sesión en navbar
    document.getElementById('logoutBtnNav').addEventListener('click', function() {
        auth.signOut();
    });

    // Soporte para submenús en Bootstrap 5
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.dropdown-submenu > a').forEach(function(element){
            element.addEventListener('mouseenter', function(e){
                let submenu = element.nextElementSibling;
                if(submenu && submenu.classList.contains('dropdown-menu')) {
                    submenu.classList.add('show');
                }
            });
            element.parentElement.addEventListener('mouseleave', function(e){
                let submenu = element.nextElementSibling;
                if(submenu && submenu.classList.contains('dropdown-menu')) {
                    submenu.classList.remove('show');
                }
            });
        });
    });

    // --- FUNCIÓN PARA FILTRAR PRODUCTOS SEGÚN LOS FILTROS SELECCIONADOS ---
function productoCoincideFiltros(producto) {
    // Filtros por campos
    for (const campo of Object.keys(filtrosSeleccionados)) {
        const valores = filtrosSeleccionados[campo];
        if (valores && valores.length > 0) {
            if (campo === 'subcategoria') {
                if (!valores.includes(producto.subcategoria)) {
                    return false;
                }
            } else if (campo === 'categoria') {
                if (!valores.includes(producto.categoria)) {
                    return false;
                }
            } else {
                if (!valores.includes(producto[campo])) {
                    return false;
                }
            }
        }
    }
    // Filtro de precio
    if (typeof producto.precio === 'number') {
        if (producto.precio < precioFiltroMin || producto.precio > precioFiltroMax) {
            return false;
        }
    }
    // Filtro de búsqueda
    if (textoBusqueda) {
        const texto = (
            (producto.nombre || '') + ' ' +
            (producto.categoria || '') + ' ' +
            (producto.subcategoria || '') + ' ' +
            (producto.marca || '') + ' ' +
            (producto.capacidad || '') + ' ' +
            (producto.modelo || '')
        ).toLowerCase();
        if (!texto.includes(textoBusqueda)) {
            return false;
        }
    }
    return true;
}

// --- EVENTO DE BÚSQUEDA ---
document.addEventListener('DOMContentLoaded', function () {
    const inputBusqueda = document.getElementById('buscadorProductos');
    if (inputBusqueda) {
        inputBusqueda.addEventListener('input', function () {
            textoBusqueda = this.value.trim().toLowerCase();
            renderProductos();
        });
    }
});

// --- ASIGNAR EVENTOS A BOTONES "VER DETALLES" ---
function asignarEventosProductos() {
    document.querySelectorAll('.btn-ver-detalles').forEach(btn => {
        btn.addEventListener('click', function () {
            const idx = parseInt(this.getAttribute('data-idx'));
            const producto = productosCache[idx];
            if (!producto) return;
            document.getElementById('detalleImagen').src = safeImageUrl(producto.imagen || '');
            document.getElementById('detalleNombre').textContent = sanitize(producto.nombre || '');
            document.getElementById('detallePrecio').textContent = producto.precio || '';
            document.getElementById('detalleMarca').textContent = sanitize(producto.marca || '');
            document.getElementById('detalleModelo').textContent = sanitize(producto.modelo || '');
            document.getElementById('detalleCapacidad').textContent = sanitize(producto.capacidad || '');
            document.getElementById('detalleDimension').textContent = sanitize(producto.dimension || '');
            document.getElementById('detalleCategoria').textContent = sanitize(producto.categoria || '');
            document.getElementById('detalleSubcategoria').textContent = sanitize(producto.subcategoria || '');
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalDetallesProducto'));
            modal.show();
        });
    });
}
    // --- CARRITO DE COMPRAS ---
let carrito = JSON.parse(localStorage.getItem('carrito')) || [];

function guardarCarrito() {
    localStorage.setItem('carrito', JSON.stringify(carrito));
    actualizarContadorCarrito();
}

function actualizarContadorCarrito() {
    const count = carrito.reduce((acc, item) => acc + item.cantidad, 0);
    const badge = document.getElementById('cartCount');
    if (badge) badge.textContent = count;
}

function renderCarrito() {
    const cont = document.getElementById('carritoContenido');
    if (!cont) return;
    if (carrito.length === 0) {
        cont.innerHTML = '<div class="text-center text-muted">El carrito está vacío.</div>';
        return;
    }
    let html = '<ul class="list-group mb-3">';
    carrito.forEach((item, idx) => {
        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <img src="${safeImageUrl(item.imagen)}" alt="${sanitize(item.nombre)}" style="width:50px;height:50px;object-fit:cover;" class="me-2 rounded">
                <span class="fw-bold">${sanitize(item.nombre)}</span><br>
                <small>S/ ${item.precio} x </small>
                <input type="number" min="1" class="form-control d-inline-block cantidad-input" data-idx="${idx}" value="${item.cantidad}" style="width:70px;display:inline-block;">
            </div>
            <div>
                <button class="btn btn-sm btn-danger btn-eliminar" data-idx="${idx}"><i class="bi bi-trash"></i></button>
            </div>
        </li>`;
    });
    html += '</ul>';
    html += `<div class="text-end fw-bold">Total: S/ ${carrito.reduce((acc, item) => acc + item.precio * item.cantidad, 0)}</div>`;
    cont.innerHTML = html;
    // Evento para cambiar cantidad
    cont.querySelectorAll('.cantidad-input').forEach(input => {
        input.addEventListener('change', function() {
            const idx = parseInt(this.dataset.idx);
            let val = parseInt(this.value);
            if (isNaN(val) || val < 1) val = 1;
            carrito[idx].cantidad = val;
            guardarCarrito();
            renderCarrito();
        });
    });
    // Evento eliminar
    cont.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', function() {
            const idx = parseInt(this.dataset.idx);
            carrito.splice(idx, 1);
            guardarCarrito();
            renderCarrito();
        });
    });
}

document.getElementById('cartBtn').addEventListener('click', function() {
    renderCarrito();
    const modal = new bootstrap.Modal(document.getElementById('modalCarrito'));
    modal.show();
});

document.getElementById('btnVaciarCarrito').addEventListener('click', function() {
    carrito = [];
    guardarCarrito();
    renderCarrito();
});

document.getElementById('btnEnviarWhatsapp').addEventListener('click', function() {
    if (carrito.length === 0) return;
    let mensaje = '¡Hola! Quiero pedir lo siguiente:%0A';
    carrito.forEach(item => {
        mensaje += `• ${item.nombre} %0A(S/ ${item.precio} x ${item.cantidad} UND)%0A`;
    });
    mensaje += `%0ATotal: S/ ${carrito.reduce((acc, item) => acc + item.precio * item.cantidad, 0)}`;
    window.open(`https://wa.me/${phone}?text=${mensaje}`, '_blank');
});

// --- AGREGAR AL CARRITO DESDE EL MODAL ---
document.getElementById('btnAgregarAlCarritoModal').addEventListener('click', function() {
    const nombre = document.getElementById('detalleNombre').textContent;
    const precio = parseFloat(document.getElementById('detallePrecio').textContent);
    const imagen = document.getElementById('detalleImagen').src;
    // Buscar en productosCache el producto exacto
    const producto = productosCache.find(p => sanitize(p.nombre) === nombre && p.precio == precio);
    if (!producto) return;
    const idx = carrito.findIndex(item => item.nombre === producto.nombre && item.precio === producto.precio);
    if (idx >= 0) {
        carrito[idx].cantidad++;
    } else {
        carrito.push({
            nombre: producto.nombre,
            precio: producto.precio,
            imagen: producto.imagen,
            cantidad: 1
        });
    }
    guardarCarrito();
    // Opcional: cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetallesProducto'));
    if (modal) modal.hide();
});

document.addEventListener('DOMContentLoaded', function() {
    actualizarContadorCarrito();
});
    // --- MODO OSCURO ---
document.addEventListener('DOMContentLoaded', function () {
    const switchOscuro = document.getElementById('modoOscuroSwitch');
    const body = document.body;
    // Inicializar desde localStorage
    const dark = localStorage.getItem('modoOscuro') === 'true';
    if (dark) {
        body.classList.add('modo-oscuro');
        if (switchOscuro) switchOscuro.checked = true;
    } else {
        body.classList.remove('modo-oscuro');
        if (switchOscuro) switchOscuro.checked = false;
    }
    if (switchOscuro) {
        switchOscuro.addEventListener('change', function () {
            if (this.checked) {
                body.classList.add('modo-oscuro');
                localStorage.setItem('modoOscuro', 'true');
            } else {
                body.classList.remove('modo-oscuro');
                localStorage.setItem('modoOscuro', 'false');
            }
        });
    }
});
// Cambia el logo según el modo claro/oscuro
function actualizarLogoNav() {
    const logo = document.querySelector('.navbar-brand img');
    if (!logo) return;
    if (document.body.classList.contains('modo-oscuro')) {
        logo.src = 'img/Logo/logo_1.png';
    } else {
        logo.src = 'img/Logo/logo_2.png';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    actualizarLogoNav();
    const switchOscuro = document.getElementById('modoOscuroSwitch');
    if (switchOscuro) {
        switchOscuro.addEventListener('change', actualizarLogoNav);
    }
});
    </script>
</body>
</html>